name: Proton Drive Backup - Scheduled Security Scan

on:
  schedule:
    # Run weekly on Mondays at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/proton-drive-backup

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 

    - name: Get latest image digest
      id: latest-image
      run: |
        # Get the latest digest from the main branch
        DIGEST=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/packages/container/proton-drive-backup/versions" \
          | jq -r '.[0].name' 2>/dev/null || echo "")

        if [ -z "$DIGEST" ] || [ "$DIGEST" = "null" ]; then
          echo "No published image found, exiting gracefully"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@$DIGEST" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Run Trivy vulnerability scanner
      if: steps.latest-image.outputs.skip == 'false'
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
      with:
        image-ref: ${{ steps.latest-image.outputs.image }}
        format: sarif
        output: trivy-results.sarif

    - name: Upload Trivy scan results to GitHub Security
      if: steps.latest-image.outputs.skip == 'false'
      uses: github/codeql-action/upload-sarif@573acd9552f33577783abde4acb66a1058e762e5 
      with:
        sarif_file: trivy-results.sarif

    - name: Log scan completion
      if: steps.latest-image.outputs.skip == 'false'
      run: |
        echo "âœ… Weekly security scan completed"
        echo "Image: ${{ steps.latest-image.outputs.image }}"
        echo "Results uploaded to GitHub Security tab for review"